services:
  # üîß Build-only service: Multi-SDK .NET execution image
  # This builds the custom image used by coding-orchestrator for C# execution
  # Run: docker-compose -f docker-compose-shared-Calzaretta.yml build dotnet-multi
  dotnet-multi:
    build:
      context: .
      dockerfile: CodingOrchestrator.Server/Dockerfile.dotnet-multi
    image: memoryagent-dotnet-multi:latest
    profiles:
      - build-only  # Won't start with normal docker-compose up

  mcp-server:
    build:
      context: .
      dockerfile: MemoryAgent.Server/Dockerfile
    container_name: memory-agent-server
    ports:
      - "5000:5000"
    volumes:
      - Z:\Memory\shared\memory:/data/memory
      - Z:\Memory\shared\logs:/data/logs
      - E:\GitHub:/workspace:rw
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:5000
      - ASPNETCORE_HTTP_PORTS=
      - Qdrant__Url=http://memory-agent-qdrant:6333
      - Neo4j__Url=bolt://memory-agent-neo4j:7687
      - Neo4j__User=neo4j
      - Neo4j__Password=memoryagent
      - Ollama__Url=http://10.0.2.20:11434
      - PathMapping__HostRoot=E:\GitHub
      - PathMapping__ContainerRoot=/workspace
      - AutoReindex__Enabled=true
      - AutoReindex__WorkspacePath=
      - AutoReindex__Context=
      - CodingOrchestrator__BaseUrl=http://memory-coding-orchestrator:5003
      - AutoTestGeneration__Enabled=true
    depends_on:
      qdrant:
        condition: service_healthy
      neo4j:
        condition: service_healthy
      # Ollama runs externally at 10.0.0.20:11434
    deploy:
      resources:
        limits:
          memory: 108G
    networks:
      - memory-net
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    # GRACEFUL SHUTDOWN: Stop MCP server FIRST before databases
    # Gives .NET app 30s to close Neo4j/Qdrant connections cleanly
    stop_grace_period: 30s
    restart: unless-stopped

  qdrant:
    image: qdrant/qdrant:latest
    container_name: memory-agent-qdrant
    ports:
      - "6333:6333"
      - "6334:6334"
    volumes:
      - Z:\Memory\shared\qdrant:/qdrant/storage
    healthcheck:
      test: ["CMD-SHELL", "timeout 5 bash -c 'cat < /dev/null > /dev/tcp/localhost/6333' || exit 1"]
      interval: 10s
      timeout: 10s
      retries: 60
      start_period: 90s
    deploy:
      resources:
        limits:
          memory: 10G
    networks:
      - memory-net
    # GRACEFUL SHUTDOWN: Give Qdrant 60s to flush data and close cleanly
    stop_grace_period: 60s
    restart: unless-stopped

  neo4j:
    image: neo4j:5.15-community
    container_name: memory-agent-neo4j
    ports:
      - "7474:7474"
      - "7687:7687"
    volumes:
      - Z:\Memory\shared\neo4j\data:/data
      - Z:\Memory\shared\neo4j\logs:/logs
      - Z:\Memory\shared\neo4j\import:/var/lib/neo4j/import
      - Z:\Memory\shared\neo4j\plugins:/plugins
    environment:
      - NEO4J_AUTH=neo4j/memoryagent
      - NEO4J_PLUGINS=["apoc"] 
      - NEO4J_dbms_memory_heap_max__size=6G
      - NEO4J_dbms_security_procedures_unrestricted=apoc.*
      - NEO4J_dbms_security_procedures_allowlist=apoc.*
      - NEO4J_dbms_threads_worker__count=16
      - NEO4J_dbms_memory_pagecache_size=2G
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --timeout=5 --spider http://localhost:7474 || exit 1"]
      interval: 15s
      timeout: 10s
      retries: 40
      start_period: 120s
    deploy:
      resources:
        limits:
          memory: 10G
    networks:
      - memory-net
    # GRACEFUL SHUTDOWN: Give Neo4j 120s to flush transactions and close cleanly
    # Neo4j needs more time than Qdrant due to transaction log flushing
    stop_grace_period: 120s
    restart: unless-stopped

  # Ollama runs externally on dual GPUs at 10.0.0.20
  # Start with: .\scripts\start-ollama-dual-gpu.ps1
  # - Port 11434 (3090): PINNED - deepseek-coder-v2:16b, phi3.5:3.8b, mxbai-embed-large (~14.2GB)
  # - Port 11435 (5070 Ti): SWAP - alternative models, auto-unload after 5 min

  # CodingOrchestrator - Coordinates the multi-agent workflow
  # üê≥ NOW WITH DOCKER EXECUTION - actually runs generated code!
  # üíæ NOW WITH JOB PERSISTENCE - survives container restarts!
  coding-orchestrator:
    build:
      context: .
      dockerfile: CodingOrchestrator.Server/Dockerfile
    container_name: memory-coding-orchestrator
    ports:
      - "5003:5003"
    volumes:
      # üê≥ Docker socket for code execution in containers
      - /var/run/docker.sock:/var/run/docker.sock
      # Temp directory for code execution
      - /tmp:/tmp
      # üíæ Job persistence - survives container restarts
      - Z:\Memory\shared\memory:/data/memory
      # üìÅ Workspace access for reading/writing code files
      - E:\GitHub:/workspace:rw
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:5003
      - MemoryAgent__BaseUrl=http://memory-agent-server:5000
      - CodingAgent__BaseUrl=http://memory-coding-agent:5001
      - ValidationAgent__BaseUrl=http://memory-validation-agent:5002
      - DesignAgent__BaseUrl=http://memory-design-agent:5004
      - JobPersistence__Path=/data/memory/orchestrator/jobs
      # üóÇÔ∏è Path translation: Windows paths ‚Üí container paths
      - PathMapping__HostRoot=E:\GitHub
      - PathMapping__ContainerRoot=/workspace
    depends_on:
      mcp-server:
        condition: service_healthy
      coding-agent:
        condition: service_healthy
      validation-agent:
        condition: service_healthy
      design-agent:
        condition: service_healthy
    networks:
      - memory-net
    # Need elevated permissions for Docker socket access
    privileged: false
    user: root
    restart: unless-stopped

  # CodingAgent - Generates and fixes code using LLM
  coding-agent:
    build:
      context: .
      dockerfile: CodingAgent.Server/Dockerfile
    container_name: memory-coding-agent
    ports:
      - "5001:5001"
    volumes:
      # üìÅ Workspace access for reading source files
      - E:\GitHub:/workspace:rw
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:5001
      - MemoryAgent__BaseUrl=http://memory-agent-server:5000
      - Ollama__Url=http://10.0.2.20:11434
      # Dual GPU: 3090 (pinned) + 5070 Ti (swap)
      - Gpu__DualGpu=true
      - Gpu__PinnedPort=11434
      - Gpu__SwapPort=11435
      # Use deepseek-coder for code generation (pinned on 3090)
      - Gpu__PrimaryModel=deepseek-coder-v2:16b
      - Gpu__PinnedGpuVram=24
      - Gpu__SwapGpuVram=16
      # deepseek-coder-v2:16b uses ~22GB, so no room for swapping on pinned GPU
      # All non-primary models should go to swap GPU (port 11435)
      - Gpu__PinnedModelsVram=23
      # ‚ö° Smart model selection ENABLED for dual GPU
      # PinnedModelsVram=23 forces alternates to swap GPU (11435)
      # deepseek stays on 3090 (11434), alternatives go to 5070 Ti
      - Gpu__UseSmartModelSelection=true
      # üóÇÔ∏è Path translation: Windows paths ‚Üí container paths
      - PathMapping__HostRoot=E:\GitHub
      - PathMapping__ContainerRoot=/workspace
      # ‚òÅÔ∏è Anthropic Claude for code generation (if configured)
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-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
      - ANTHROPIC_MODEL=${ANTHROPIC_MODEL:-claude-sonnet-4-20250514}
      - ANTHROPIC_MODEL_PREMIUM=${ANTHROPIC_MODEL_PREMIUM:-claude-opus-4-20250514}
    depends_on:
      mcp-server:
        condition: service_healthy
    networks:
      - memory-net
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5001/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 15s
    restart: unless-stopped

  # ValidationAgent - Validates code quality with LLM
  # Uses 5070 Ti (port 11435) for phi4 - keeps 3090 free for code generation
  validation-agent:
    build:
      context: .
      dockerfile: ValidationAgent.Server/Dockerfile
    container_name: memory-validation-agent
    ports:
      - "5002:5002"
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:5002
      - MemoryAgent__BaseUrl=http://memory-agent-server:5000
      # ‚ö° Route validation to 5070 Ti (port 11435) - phi4 runs there
      - Ollama__Url=http://10.0.2.20:11435
      - Ollama__Port=11435
      - Gpu__ValidationModel=phi4:latest
      # Dual GPU: 3090 (pinned code gen) + 5070 Ti (validation)
      - Gpu__DualGpu=true
      - Gpu__PinnedPort=11434
      - Gpu__SwapPort=11435
      # Smart selection ON - can use different validation models on 5070 Ti
      - Gpu__UseSmartModelSelection=true
    depends_on:
      mcp-server:
        condition: service_healthy
    networks:
      - memory-net
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5002/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 15s
    restart: unless-stopped

  # DesignAgent - UX Design system, brand guidelines, validation (now with LLM!)
  design-agent:
    build:
      context: .
      dockerfile: DesignAgent.Server/Dockerfile
    container_name: memory-design-agent
    ports:
      - "5004:5004"
    volumes:
      - Z:\Memory\shared\screenshots:/data/screenshots
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:5004
      - MemoryAgent__BaseUrl=http://memory-agent-server:5000
      # üß† LLM for creative brand generation and intelligent validation
      - Ollama__Url=http://10.0.2.20:11434
      - Ollama__Port=11434
      - Ollama__DefaultModel=deepseek-coder-v2:16b
      # üîå Database connections for design intelligence storage
      - ConnectionStrings__Neo4j=bolt://memory-agent-neo4j:7687
      - ConnectionStrings__Qdrant=http://memory-agent-qdrant:6333
      - Neo4jCredentials__Username=neo4j
      - Neo4jCredentials__Password=memoryagent
      # üé® Design Intelligence Configuration
      - DesignIntelligence__InitialThreshold=7.0
      - DesignIntelligence__LeaderboardSize=100
      - DesignIntelligence__MaxPagesPerSite=6
      - DesignIntelligence__CrawlDelayMs=2000
      - DesignIntelligence__PlaywrightTimeoutMs=30000
      - DesignIntelligence__ScreenshotPath=/data/screenshots
      - DesignIntelligence__ScreenshotQuality=85
      - DesignIntelligence__ScreenshotBreakpoints=[1920,1024,375]
      - DesignIntelligence__EnableVideoCapture=false
      - DesignIntelligence__VideoCaptureDurationSec=10
      # üîç Multi-Provider Search with Automatic Fallback
      # Primary provider: Google (will auto-fallback: Bing ‚Üí Brave ‚Üí DuckDuckGo ‚Üí Serper)
      # Rotation happens automatically when rate limits hit or API fails
      - DesignIntelligence__SearchProvider=google
      - DesignIntelligence__SearchApiKey=AIzaSyC-Cd7PNmIeI-p-I1l4iWSDGv1hnN1CiK4
      - DesignIntelligence__SearchEngineId=95aa19bb6b9bb462a
      # Optional fallback API keys (Bing & DuckDuckGo will use free HTML scraping if empty)
      - DesignIntelligence__BingApiKey=
      - DesignIntelligence__BraveApiKey=BSA9cc95HtCTdGYUjMeaix1TrAj35R7
      - DesignIntelligence__SerperApiKey=
      # Note: Serper no longer has a free tier (paid only: $50/month)
      - DesignIntelligence__SearchQueriesPerRun=5
      - DesignIntelligence__SearchResultsPerQuery=10
      - DesignIntelligence__EnableBackgroundLearning=true
      - DesignIntelligence__BackgroundIntervalSec=3600
      - DesignIntelligence__MaxCpuPercent=30
      - DesignIntelligence__MinFeedbackForEvolution=10
      - DesignIntelligence__MismatchThreshold=2.0
      - DesignIntelligence__VisionModel=llava:latest
      - DesignIntelligence__TextModel=phi4
      - DesignIntelligence__LlmTimeoutSec=120
    depends_on:
      mcp-server:
        condition: service_healthy
      neo4j:
        condition: service_healthy
      qdrant:
        condition: service_healthy
    networks:
      - memory-net
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5004/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 15s
    restart: unless-stopped

networks:
  memory-net:
    name: memory-shared-net
    driver: bridge

