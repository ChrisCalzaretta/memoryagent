services:
  mcp-server:
    build:
      context: .
      dockerfile: MemoryAgent.Server/Dockerfile
    container_name: ${PROJECT_NAME:-memory}-agent-server
    ports:
      - "${MCP_PORT:-5000}:5000"
    volumes:
      - d:\Memory\${PROJECT_NAME:-default}\memory:/data/memory
      - d:\Memory\${PROJECT_NAME:-default}\logs:/data/logs
      - ${PROJECT_PATH:-E:\GitHub}:/workspace:ro
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:5000
      - ASPNETCORE_HTTP_PORTS=
      - Qdrant__Url=${QDRANT_URL:-http://${PROJECT_NAME:-memory}-agent-qdrant:6333}
      - Neo4j__Url=${NEO4J_URL:-bolt://${PROJECT_NAME:-memory}-agent-neo4j:7687}
      - Neo4j__User=${NEO4J_USER:-neo4j}
      - Neo4j__Password=${NEO4J_PASSWORD:-memoryagent}
      - Ollama__Url=${OLLAMA_URL:-http://${PROJECT_NAME:-memory}-agent-ollama:11434}
      - PathMapping__HostRoot=${HOST_ROOT}
      - PathMapping__ContainerRoot=/workspace
      - AutoReindex__Enabled=${AUTO_REINDEX_ENABLED:-true}
      - AutoReindex__WorkspacePath=${CONTAINER_PATH:-/workspace}
      - AutoReindex__Context=${CONTEXT_NAME:-default}
    depends_on:
      qdrant:
        condition: service_started
      neo4j:
        condition: service_started
      ollama:
        condition: service_healthy
    deploy:
      resources:
        limits:
          memory: 108G
    networks:
      - agent-net
    restart: unless-stopped

  qdrant:
    image: qdrant/qdrant:latest
    container_name: ${PROJECT_NAME:-memory}-agent-qdrant
    ports:
      - "${QDRANT_HTTP_PORT:-6333}:6333"
      - "${QDRANT_GRPC_PORT:-6334}:6334"
    volumes:
      - d:\Memory\${PROJECT_NAME:-default}\qdrant:/qdrant/storage
    deploy:
      resources:
        limits:
          memory: 10G
    networks:
      - agent-net
    restart: unless-stopped

  neo4j:
    image: neo4j:5.15-community
    container_name: ${PROJECT_NAME:-memory}-agent-neo4j
    ports:
      - "${NEO4J_HTTP_PORT:-7474}:7474"
      - "${NEO4J_BOLT_PORT:-7687}:7687"
    volumes:
      - d:\Memory\${PROJECT_NAME:-default}\neo4j\data:/data
      - d:\Memory\${PROJECT_NAME:-default}\neo4j\logs:/logs
      - d:\Memory\${PROJECT_NAME:-default}\neo4j\import:/var/lib/neo4j/import
      - d:\Memory\${PROJECT_NAME:-default}\neo4j\plugins:/plugins
    environment:
      - NEO4J_AUTH=neo4j/${NEO4J_PASSWORD:-memoryagent}
      - NEO4J_PLUGINS=["apoc"]
      - NEO4J_dbms_memory_heap_max__size=6G
      - NEO4J_dbms_security_procedures_unrestricted=apoc.*
      - NEO4J_dbms_security_procedures_allowlist=apoc.*
      - NEO4J_dbms_threads_worker__count=16
      - NEO4J_dbms_memory_pagecache_size=2G
    deploy:
      resources:
        limits:
          memory: 10G
    networks:
      - agent-net
    restart: unless-stopped

  ollama:
    image: ollama/ollama:latest
    container_name: ${PROJECT_NAME:-memory}-agent-ollama
    ports:
      - "${OLLAMA_PORT:-11434}:11434"
    volumes:
      - d:\Memory\${PROJECT_NAME:-default}\ollama:/root/.ollama
      - ./ollama-entrypoint.sh:/usr/local/bin/ollama-entrypoint.sh:ro
    entrypoint: ["/bin/bash", "/usr/local/bin/ollama-entrypoint.sh"]
    environment:
      # Force Ollama to use only GPU 1 (5070 Ti 16GB) - avoids crashing 3090
      - CUDA_VISIBLE_DEVICES=1
      - NVIDIA_VISIBLE_DEVICES=1
      # Keep models loaded in VRAM indefinitely (-1 = never unload)
      - OLLAMA_KEEP_ALIVE=-1
    healthcheck:
      test: ["CMD", "bash", "-c", "ollama list | grep -q mxbai-embed-large"]
      interval: 10s
      timeout: 5s
      retries: 30
      start_period: 60s
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
    networks:
      - agent-net
    restart: unless-stopped

  # CodingOrchestrator - Coordinates the multi-agent workflow
  coding-orchestrator:
    build:
      context: .
      dockerfile: CodingOrchestrator.Server/Dockerfile
    container_name: ${PROJECT_NAME:-memory}-coding-orchestrator
    ports:
      - "${ORCHESTRATOR_PORT:-5003}:5003"
    volumes:
      - d:\Memory\${PROJECT_NAME:-default}\memory:/data/memory
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:5003
      - MemoryAgent__BaseUrl=http://${PROJECT_NAME:-memory}-agent-server:5000
      - CodingAgent__BaseUrl=http://${PROJECT_NAME:-memory}-coding-agent:5001
      - ValidationAgent__BaseUrl=http://${PROJECT_NAME:-memory}-validation-agent:5002
      - JobPersistence__Path=/data/memory/orchestrator/jobs
    depends_on:
      - mcp-server
      - coding-agent
      - validation-agent
    networks:
      - agent-net
    restart: unless-stopped

  # CodingAgent - Generates and fixes code using LLM
  coding-agent:
    build:
      context: .
      dockerfile: CodingAgent.Server/Dockerfile
    container_name: ${PROJECT_NAME:-memory}-coding-agent
    ports:
      - "${CODING_AGENT_PORT:-5001}:5001"
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:5001
      - Ollama__Url=${OLLAMA_URL:-http://${PROJECT_NAME:-memory}-agent-ollama:11434}
    depends_on:
      - ollama
    networks:
      - agent-net
    restart: unless-stopped

  # ValidationAgent - Validates code quality
  validation-agent:
    build:
      context: .
      dockerfile: ValidationAgent.Server/Dockerfile
    container_name: ${PROJECT_NAME:-memory}-validation-agent
    ports:
      - "${VALIDATION_AGENT_PORT:-5002}:5002"
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:5002
      - MemoryAgent__BaseUrl=http://${PROJECT_NAME:-memory}-agent-server:5000
    depends_on:
      - mcp-server
    networks:
      - agent-net
    restart: unless-stopped

networks:
  agent-net:
    name: ${PROJECT_NAME:-memory}-net
    driver: bridge
