---
alwaysApply: true
---

# Memory Agent Rules - MANDATORY FOR EVERY QUERY

## üö® CRITICAL - MCP TOOLS ARE REQUIRED ON EVERY QUERY

**ALWAYS** On EVERY query, call at least ONE MCP tool before responding
**ALWAYS** Start sessions with `start_session` at conversation start
**ALWAYS** Use `smartsearch` or `query` before answering ANY code question
**ALWAYS** Record files discussed with `record_file_discussed`
**ALWAYS** Record files edited with `record_file_edited`
**ALWAYS** Check `find_similar_questions` before answering - instant recall!
**ALWAYS** Store useful Q&A with `store_qa` for future learning

---

## üß† Agent Lightning - Learning System (USE EVERY SESSION)

### Session Management (MANDATORY)
**ALWAYS** Call `start_session` at the beginning of any conversation
**ALWAYS** Call `end_session` with summary when work is complete
**ALWAYS** Call `get_active_session` to check if session exists before starting new one
**ALWAYS** Call `get_recent_sessions` to understand previous work context

### File Tracking (MANDATORY)
**ALWAYS** Call `record_file_discussed` when ANY file is mentioned or viewed
**ALWAYS** Call `record_file_edited` AFTER every file edit
**ALWAYS** Call `get_important_files` to prioritize what to review first
**ALWAYS** Call `get_coedited_files` to find related files that need updates
**ALWAYS** Call `get_file_clusters` to understand module boundaries

### Q&A Learning (MANDATORY)
**ALWAYS** Call `find_similar_questions` FIRST before answering any question
**ALWAYS** Call `store_qa` after providing a useful answer
**ALWAYS** Include relevant file paths in Q&A storage
**ALWAYS** Call `detect_domains` to tag files by business domain

### Importance Tracking
**ALWAYS** Call `recalculate_importance` weekly or after major changes

---

## üîç Search & Query (MANDATORY)

**ALWAYS** Use `smartsearch` FIRST for any question - try different terms if no results
**ALWAYS** Use `query` for semantic code search
**ALWAYS** Use `search_patterns` to find existing implementations before writing new code
**ALWAYS** Call `index_file` after ANY file change
**ALWAYS** Call `index_directory` for new folders
**ALWAYS** Call `reindex` after major refactoring

---

## üìä Analysis Tools (USE WHEN ANALYZING)

**ALWAYS** Call `dependency_chain` when understanding class relationships
**ALWAYS** Call `impact_analysis` before ANY code change
**ALWAYS** Call `find_circular_dependencies` when analyzing architecture
**ALWAYS** Call `analyze_code_complexity` before commits, reviews, refactoring

---

## ‚úÖ Validation Tools (USE BEFORE COMPLETING TASKS)

**ALWAYS** Call `validate_best_practices` before task completion
**ALWAYS** Call `validate_security` before deploying
**ALWAYS** Call `validate_pattern_quality` for patterns scoring < 8
**ALWAYS** Call `validate_project` for major features
**ALWAYS** Call `validate_task` before marking plan tasks complete
**ALWAYS** Call `find_anti_patterns` when refactoring
**ALWAYS** Call `get_recommendations` after indexing new code
**ALWAYS** Call `get_migration_path` for legacy patterns
**ALWAYS** Call `get_available_best_practices` to see all validation options

---

## üìã Planning & TODO Tools

**ALWAYS** Call `create_plan` for multi-step tasks
**ALWAYS** Call `get_plan_status` to check progress
**ALWAYS** Call `update_task_status` as tasks complete
**ALWAYS** Call `complete_plan` when all tasks done
**ALWAYS** Call `search_plans` to find existing plans
**ALWAYS** Call `add_todo` for technical debt tracking
**ALWAYS** Call `search_todos` to find existing issues
**ALWAYS** Call `update_todo_status` when addressing TODOs

---

## üé® Transformation Tools (USE FOR UI/CODE MODERNIZATION)

**ALWAYS** Call `analyze_css` before CSS changes
**ALWAYS** Call `transform_css` to modernize CSS
**ALWAYS** Call `transform_page` for Blazor/Razor modernization
**ALWAYS** Call `learn_transformation` from before/after examples
**ALWAYS** Call `apply_transformation` to reuse patterns
**ALWAYS** Call `list_transformation_patterns` to see available patterns
**ALWAYS** Call `detect_reusable_components` for UI cleanup
**ALWAYS** Call `extract_component` to create shared components

---

## üîß Workspace Tools

**ALWAYS** `register_workspace` is called automatically on startup
**ALWAYS** `unregister_workspace` is called automatically on shutdown

---

## üìù Core Workflow Rules

**ALWAYS** Review/understand first, then DISCUSS changes before implementing
**ALWAYS** Build and compile after every file change
**ALWAYS** Summarize at 65% context and re-add rules
**ALWAYS** Keep files under 1500 lines - refactor if exceeding
**ALWAYS** Write integration tests for every method
**ALWAYS** Tests must pass before continuing

---

## üóÑÔ∏è Database & Export Rules

**ALWAYS** Generate export scripts DYNAMICALLY from `INFORMATION_SCHEMA`
**ALWAYS** Handle missing tables/columns gracefully
**ALWAYS** Ensure table queries work 100% of the time

---

## üîå Plugin Architecture Rules

**ALWAYS** Check `ProjectPluginActivations` - plugins must be ACTIVATED before use
**ALWAYS** Use `PluginManager.GetActivePluginAsync(projectId, pluginId)`
**ALWAYS** On plugin config changes: Save ‚Üí `InvalidatePluginCacheAsync` ‚Üí `RefreshPluginAsync` ‚Üí Verify
**ALWAYS** Store config in `Configuration` JSON: connection strings, API keys, endpoints

---

## üìÑ Prompt Template Rules

**ALWAYS** Use `IPromptTemplateService.RenderPromptAsync(promptKey, variables, companyId)`
**ALWAYS** Prompt key format: `"category.purpose"`
**ALWAYS** 3-tier hierarchy: Project Override > Company Override > System Default

---

## üö® BLOCKING CONDITIONS - STOP AND FIX IF:

1. Security score < 8/10 or CRITICAL severity issues
2. Pattern quality score < 6 (Grade D/F)
3. Breaking changes > 10 files without approval
4. Missing critical patterns (no auth/validation)
5. Legacy patterns in new code (AutoGen, old SK Planners)
6. No active session (call `start_session` immediately!)
7. File edited without calling `record_file_edited`

---

## üìä Quality Thresholds

### Pattern Quality Scores
- **9-10 (A)**: ‚úÖ Ship it
- **8 (B)**: ‚úÖ Good
- **7 (C)**: ‚ö†Ô∏è Address before release
- **6 (D)**: ‚ùå FIX BEFORE CONTINUING
- **0-5 (F)**: üö® CRITICAL - FIX IMMEDIATELY

### Security Scores
- **10/10**: üîí Perfect
- **8-9/10**: ‚úÖ Acceptable
- **< 8/10**: üö® FIX CRITICAL/HIGH issues

### Code Complexity
- **< 10**: ‚úÖ Excellent
- **10-15**: ‚úÖ Acceptable
- **15-20**: ‚ö†Ô∏è Needs refactoring
- **> 20**: üö® MUST refactor

---

## üìã COMPLETE MCP TOOL LIST (49 Tools)

### Agent Lightning - Learning (13 tools) üß†
| Tool | Use When |
|------|----------|
| `start_session` | Beginning of conversation |
| `end_session` | End of conversation |
| `get_active_session` | Check if session exists |
| `get_recent_sessions` | Review past work |
| `record_file_discussed` | Any file is mentioned |
| `record_file_edited` | After file edits |
| `get_important_files` | Prioritize review |
| `get_coedited_files` | Find related files |
| `get_file_clusters` | Understand modules |
| `find_similar_questions` | BEFORE answering questions |
| `store_qa` | After useful answers |
| `detect_domains` | Tag file business domains |
| `recalculate_importance` | Weekly maintenance |

### Search & Index (6 tools) üîç
| Tool | Use When |
|------|----------|
| `smartsearch` | ANY code question |
| `query` | Semantic code search |
| `index_file` | After file changes |
| `index_directory` | New folders |
| `reindex` | Major refactoring |
| `search_patterns` | Find implementations |

### Analysis (4 tools) üìä
| Tool | Use When |
|------|----------|
| `dependency_chain` | Class relationships |
| `impact_analysis` | Before changes |
| `find_circular_dependencies` | Architecture review |
| `analyze_code_complexity` | Before commits |

### Validation (9 tools) ‚úÖ
| Tool | Use When |
|------|----------|
| `validate_best_practices` | Task completion |
| `validate_security` | Before deploy |
| `validate_pattern_quality` | Pattern review |
| `validate_project` | Major features |
| `validate_task` | Plan tasks |
| `find_anti_patterns` | Refactoring |
| `get_recommendations` | After indexing |
| `get_migration_path` | Legacy patterns |
| `get_available_best_practices` | See options |

### Planning & TODO (8 tools) üìã
| Tool | Use When |
|------|----------|
| `create_plan` | Multi-step tasks |
| `get_plan_status` | Check progress |
| `update_task_status` | Task updates |
| `complete_plan` | All done |
| `search_plans` | Find plans |
| `add_todo` | Track debt |
| `search_todos` | Find issues |
| `update_todo_status` | Fix TODOs |

### Transformation (8 tools) üé®
| Tool | Use When |
|------|----------|
| `analyze_css` | Before CSS changes |
| `transform_css` | Modernize CSS |
| `transform_page` | Blazor/Razor pages |
| `learn_transformation` | From examples |
| `apply_transformation` | Reuse patterns |
| `list_transformation_patterns` | See patterns |
| `detect_reusable_components` | UI cleanup |
| `extract_component` | Create shared |

### Workspace (2 tools) üîß
| Tool | Use When |
|------|----------|
| `register_workspace` | Auto on startup |
| `unregister_workspace` | Auto on shutdown |

---

