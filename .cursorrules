---
alwaysApply: true
---

# Memory Agent Rules - MANDATORY FOR EVERY QUERY

## üö® CRITICAL - MCP TOOLS ARE REQUIRED ON EVERY QUERY
**AUTO** Context = workspace folder name (e.g., "memoryagent")
**ALWAYS** On EVERY query, call at least ONE MCP tool before responding
**ALWAYS** Call `get_context` before starting ANY task
**ALWAYS** Use `smartsearch` before answering ANY code question
**ALWAYS** Check `find_similar_questions` before answering - instant recall!
**ALWAYS** Store useful Q&A with `store_qa` for future learning
**AUTO** Sessions start automatically on first tool call
**AUTO** Files in tool arguments are automatically recorded as "discussed"

---

## üß† Agent Lightning - Learning System (AUTO-ENABLED)

### Session Management (AUTOMATIC ‚úÖ)
**AUTO** Sessions are automatically started on first tool call per context
**AUTO** Files in tool arguments are automatically recorded as "discussed"
**AUTO** Context = workspace folder name (e.g., "memoryagent")
**OPTIONAL** Call `record_file_edited` for files edited outside tool calls
**OPTIONAL** Call `workspace_status` to see what Lightning knows about this workspace

### Q&A Learning (MANDATORY)
**ALWAYS** Call `find_similar_questions` FIRST before answering any question
**ALWAYS** Call `store_qa` after providing a useful answer
**ALWAYS** Include relevant file paths in Q&A storage

---

## üîç Search & Indexing (MANDATORY)

**ALWAYS** Use `smartsearch` for ANY code question (auto-detects best strategy)
**ALWAYS** Call `index` with scope='file' after ANY file change
**ALWAYS** Call `index` with scope='directory' for new folders
**ALWAYS** Call `index` with scope='reindex' after major refactoring

---

## üìä Analysis & Validation

**ALWAYS** Call `dependency_chain` when understanding class relationships
**ALWAYS** Call `impact_analysis` before ANY code change
**ALWAYS** Call `analyze_complexity` before commits, reviews, refactoring
**ALWAYS** Call `validate` with appropriate scope before task completion:
  - scope='best_practices' - For general validation
  - scope='security' - Before deploying
  - scope='pattern_quality' - For patterns scoring < 8
  - scope='anti_patterns' - When refactoring
  - scope='project' - For comprehensive validation

---

## üìã Planning & TODO

**ALWAYS** Call `manage_plan` with action='create' for multi-step tasks
**ALWAYS** Call `manage_plan` with action='get_status' to check progress
**ALWAYS** Call `manage_plan` with action='update_task' as tasks complete
**ALWAYS** Call `manage_plan` with action='validate_task' before completing tasks
**ALWAYS** Call `manage_todos` with action='add' for technical debt tracking
**ALWAYS** Call `manage_todos` with action='search' to find existing issues

---

## üéØ Intelligence & Insights

**ALWAYS** Call `get_recommendations` after indexing new code
**ALWAYS** Call `get_important_files` to prioritize what to review first
**ALWAYS** Call `get_coedited_files` to find related files that need updates
**ALWAYS** Call `get_insights` with appropriate category for metrics

---

## üé® Transformation (USE FOR UI/CODE MODERNIZATION)

**ALWAYS** Call `transform` with type='analyze_css' before CSS changes
**ALWAYS** Call `transform` with type='css' to modernize CSS
**ALWAYS** Call `transform` with type='page' for Blazor/Razor modernization
**ALWAYS** Call `transform` with type='learn_pattern' from before/after examples
**ALWAYS** Call `transform` with type='detect_components' for UI cleanup
**ALWAYS** Call `get_migration_path` for legacy patterns

---

## üîÑ Evolving System (PROMPTS & PATTERNS)

**ALWAYS** Call `manage_prompts` to view/manage LLM prompts
**ALWAYS** Call `manage_patterns` to view/manage code patterns
**ALWAYS** Call `feedback` after prompt/pattern usage to improve the system

---

## üé® Design Agent - Brand Guidelines & UI Validation

The **Design Agent** manages brand systems, design tokens, and validates UI code against brand guidelines.

### When to Use Design Tools
**USE** Design tools for:
- Creating brand/style guidelines for new projects
- Validating UI code follows brand guidelines
- Getting design tokens (colors, fonts, spacing)
- Ensuring accessibility compliance (WCAG AA/AAA)

### Design Tools (via CodingOrchestrator)
| Tool | Description |
|------|-------------|
| `design_questionnaire` | Get brand builder questions |
| `design_create_brand` | Create complete brand system from answers |
| `design_get_brand` | Get brand by context name |
| `design_list_brands` | List all available brands |
| `design_validate` | Validate code against brand guidelines |
| `design_update_brand` | Update brand settings |

### Design Workflow
```
1. design_questionnaire ‚Üí Get questions
2. design_create_brand ‚Üí Create brand with answers
3. design_validate ‚Üí Validate UI code (score >= 8)
4. Fix issues ‚Üí Re-validate
```

---

## ü§ñ Multi-Agent Code Generation

The **CodingOrchestrator** provides multi-agent code generation with automatic validation:
- **CodingAgent**: Generates/fixes code using LLM (deepseek-v2:16b)
- **ValidationAgent**: Validates code quality using rules + LLM (phi4)
- **Smart Model Rotation**: Uses different models on retry for fresh perspectives

### When to Use Multi-Agent Generation
**USE** `orchestrate_task` for:
- Creating new services, classes, or components
- Complex multi-file implementations
- Tasks requiring quality validation (score >= 8/10)
- When you want iterative refinement until quality passes

**DON'T USE** for:
- Simple one-line changes
- Quick fixes that don't need validation
- Tasks you can complete faster manually

### Orchestrator Tools
| Tool | Description |
|------|-------------|
| `orchestrate_task` | Start multi-agent coding (returns job ID) |
| `get_task_status` | Check progress and validation scores |
| `apply_task_files` | Get files with write instructions (when complete) |
| `cancel_task` | Cancel a running task |
| `list_tasks` | List all active/recent tasks |
| `design_questionnaire` | Get brand builder questions |
| `design_create_brand` | Create brand system from answers |
| `design_get_brand` | Get existing brand definition |
| `design_list_brands` | List all brands |
| `design_validate` | Validate code against brand |
| `design_update_brand` | Update brand settings |

### Example Workflow
```
1. orchestrate_task(task: "Create a UserService with CRUD operations")
   ‚Üí Returns jobId: "abc123"

2. get_task_status(jobId: "abc123")
   ‚Üí Shows progress: 40%, iteration 2/5, validation score 6/10

3. get_task_status(jobId: "abc123")  (later)
   ‚Üí COMPLETE! Score 9/10, shows generated files
```

---

## üìù Core Workflow Rules

**ALWAYS** Review/understand first, then DISCUSS changes before implementing
**ALWAYS** Build and compile after every file change
**ALWAYS** Summarize at 65% context and re-add rules
**ALWAYS** Keep files under 1500 lines - refactor if exceeding
**ALWAYS** Write integration tests for every method
**ALWAYS** Tests must pass before continuing

---

## üö® BLOCKING CONDITIONS - STOP AND FIX IF:

1. Security score < 8/10 or CRITICAL severity issues
2. Pattern quality score < 6 (Grade D/F)
3. Breaking changes > 10 files without approval
4. Missing critical patterns (no auth/validation)
5. Legacy patterns in new code (AutoGen, old SK Planners)

---

## üìä Quality Thresholds

### Pattern Quality Scores
- **9-10 (A)**: ‚úÖ Ship it
- **8 (B)**: ‚úÖ Good
- **7 (C)**: ‚ö†Ô∏è Address before release
- **6 (D)**: ‚ùå FIX BEFORE CONTINUING
- **0-5 (F)**: üö® CRITICAL - FIX IMMEDIATELY

### Security Scores
- **10/10**: üîí Perfect
- **8-9/10**: ‚úÖ Acceptable
- **< 8/10**: üö® FIX CRITICAL/HIGH issues

### Code Complexity
- **< 10**: ‚úÖ Excellent
- **10-15**: ‚úÖ Acceptable
- **15-20**: ‚ö†Ô∏è Needs refactoring
- **> 20**: üö® MUST refactor
---