services:
  mcp-server:
    build:
      context: .
      dockerfile: MemoryAgent.Server/Dockerfile
    container_name: memory-agent-server
    ports:
      - "5000:5000"
    volumes:
      - d:\Memory\shared\memory:/data/memory
      - d:\Memory\shared\logs:/data/logs
      - E:\GitHub:/workspace:ro
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:5000
      - ASPNETCORE_HTTP_PORTS=
      - Qdrant__Url=http://memory-agent-qdrant:6333
      - Neo4j__Url=bolt://memory-agent-neo4j:7687
      - Neo4j__User=neo4j
      - Neo4j__Password=memoryagent
      - Ollama__Url=http://memory-agent-ollama:11434
      - PathMapping__HostRoot=E:\GitHub
      - PathMapping__ContainerRoot=/workspace
      - AutoReindex__Enabled=true
      - AutoReindex__WorkspacePath=
      - AutoReindex__Context=
    depends_on:
      qdrant:
        condition: service_healthy
      neo4j:
        condition: service_healthy
      ollama:
        condition: service_healthy
    deploy:
      resources:
        limits:
          memory: 108G
    networks:
      - memory-net
    restart: unless-stopped

  qdrant:
    image: qdrant/qdrant:latest
    container_name: memory-agent-qdrant
    ports:
      - "6333:6333"
      - "6334:6334"
    volumes:
      - d:\Memory\shared\qdrant:/qdrant/storage
    healthcheck:
      test: ["CMD-SHELL", "timeout 5 bash -c 'cat < /dev/null > /dev/tcp/localhost/6333' || exit 1"]
      interval: 10s
      timeout: 10s
      retries: 60
      start_period: 90s
    deploy:
      resources:
        limits:
          memory: 10G
    networks:
      - memory-net
    restart: unless-stopped

  neo4j:
    image: neo4j:5.15-community
    container_name: memory-agent-neo4j
    ports:
      - "7474:7474"
      - "7687:7687"
    volumes:
      - d:\Memory\shared\neo4j\data:/data
      - d:\Memory\shared\neo4j\logs:/logs
      - d:\Memory\shared\neo4j\import:/var/lib/neo4j/import
      - d:\Memory\shared\neo4j\plugins:/plugins
    environment:
      - NEO4J_AUTH=neo4j/memoryagent
      - NEO4J_PLUGINS=["apoc"]
      - NEO4J_dbms_memory_heap_max__size=6G
      - NEO4J_dbms_security_procedures_unrestricted=apoc.*
      - NEO4J_dbms_security_procedures_allowlist=apoc.*
      - NEO4J_dbms_threads_worker__count=16
      - NEO4J_dbms_memory_pagecache_size=2G
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --timeout=5 --spider http://localhost:7474 || exit 1"]
      interval: 15s
      timeout: 10s
      retries: 40
      start_period: 120s
    deploy:
      resources:
        limits:
          memory: 10G
    networks:
      - memory-net
    restart: unless-stopped

  ollama:
    image: ollama/ollama:latest
    container_name: memory-agent-ollama
    ports:
      - "11434:11434"
    volumes:
      - d:\Memory\shared\ollama:/root/.ollama
      - ./ollama-entrypoint.sh:/usr/local/bin/ollama-entrypoint.sh:ro
    entrypoint: ["/bin/bash", "/usr/local/bin/ollama-entrypoint.sh"]
    healthcheck:
      test: ["CMD", "bash", "-c", "ollama list | grep -q mxbai-embed-large"]
      interval: 10s
      timeout: 5s
      retries: 30
      start_period: 60s
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
    networks:
      - memory-net
    restart: unless-stopped

networks:
  memory-net:
    name: memory-shared-net
    driver: bridge

