services:
  mcp-server:
    build:
      context: .
      dockerfile: MemoryAgent.Server/Dockerfile
    container_name: memory-agent-server
    ports:
      - "5000:5000"
    volumes:
      - d:\Memory\shared\memory:/data/memory
      - d:\Memory\shared\logs:/data/logs
      - h:\code\git:/workspace:rw
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:5000
      - ASPNETCORE_HTTP_PORTS=
      - Qdrant__Url=http://memory-agent-qdrant:6333
      - Neo4j__Url=bolt://memory-agent-neo4j:7687
      - Neo4j__User=neo4j
      - Neo4j__Password=memoryagent
      - Ollama__Url=http://10.10.1.114:11434
      - PathMapping__HostRoot=h:\code\git
      - PathMapping__ContainerRoot=/workspace
      - AutoReindex__Enabled=true
      - AutoReindex__WorkspacePath=
      - AutoReindex__Context=
      - CodingOrchestrator__BaseUrl=http://memory-coding-orchestrator:5003
      - AutoTestGeneration__Enabled=true
    depends_on:
      qdrant:
        condition: service_healthy
      neo4j:
        condition: service_healthy
      # Ollama runs externally at 10.10.1.114:11434
    deploy:
      resources:
        limits:
          memory: 108G
    networks:
      - memory-net
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    # GRACEFUL SHUTDOWN: Stop MCP server FIRST before databases
    # Gives .NET app 30s to close Neo4j/Qdrant connections cleanly
    stop_grace_period: 30s
    restart: unless-stopped

  qdrant:
    image: qdrant/qdrant:latest
    container_name: memory-agent-qdrant
    ports:
      - "6333:6333"
      - "6334:6334"
    volumes:
      - d:\Memory\shared\qdrant:/qdrant/storage
    healthcheck:
      test: ["CMD-SHELL", "timeout 5 bash -c 'cat < /dev/null > /dev/tcp/localhost/6333' || exit 1"]
      interval: 10s
      timeout: 10s
      retries: 60
      start_period: 90s
    deploy:
      resources:
        limits:
          memory: 10G
    networks:
      - memory-net
    # GRACEFUL SHUTDOWN: Give Qdrant 60s to flush data and close cleanly
    stop_grace_period: 60s
    restart: unless-stopped

  neo4j:
    image: neo4j:5.15-community
    container_name: memory-agent-neo4j
    ports:
      - "7474:7474"
      - "7687:7687"
    volumes:
      - d:\Memory\shared\neo4j\data:/data
      - d:\Memory\shared\neo4j\logs:/logs
      - d:\Memory\shared\neo4j\import:/var/lib/neo4j/import
      - d:\Memory\shared\neo4j\plugins:/plugins
    environment:
      - NEO4J_AUTH=neo4j/memoryagent
      - NEO4J_PLUGINS=["apoc"]
      - NEO4J_dbms_memory_heap_max__size=6G
      - NEO4J_dbms_security_procedures_unrestricted=apoc.*
      - NEO4J_dbms_security_procedures_allowlist=apoc.*
      - NEO4J_dbms_threads_worker__count=16
      - NEO4J_dbms_memory_pagecache_size=2G
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --timeout=5 --spider http://localhost:7474 || exit 1"]
      interval: 15s
      timeout: 10s
      retries: 40
      start_period: 120s
    deploy:
      resources:
        limits:
          memory: 10G
    networks:
      - memory-net
    # GRACEFUL SHUTDOWN: Give Neo4j 120s to flush transactions and close cleanly
    # Neo4j needs more time than Qdrant due to transaction log flushing
    stop_grace_period: 120s
    restart: unless-stopped

  # Ollama runs externally at 10.10.1.114:11434
  # Start with: ollama serve (or your local Ollama setup)

  # CodingOrchestrator - Coordinates the multi-agent workflow
  # üê≥ NOW WITH DOCKER EXECUTION - actually runs generated code!
  # üíæ NOW WITH JOB PERSISTENCE - survives container restarts!
  coding-orchestrator:
    build:
      context: .
      dockerfile: CodingOrchestrator.Server/Dockerfile
    container_name: memory-coding-orchestrator
    ports:
      - "5003:5003"
    volumes:
      # üê≥ Docker socket for code execution in containers
      - /var/run/docker.sock:/var/run/docker.sock
      # Temp directory for code execution
      - /tmp:/tmp
      # üíæ Job persistence - survives container restarts
      - d:\Memory\shared\memory:/data/memory
      # üìÅ Workspace access for reading/writing code files
      - h:\code\git:/workspace:rw
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:5003
      - MemoryAgent__BaseUrl=http://memory-agent-server:5000
      - CodingAgent__BaseUrl=http://memory-coding-agent:5001
      - ValidationAgent__BaseUrl=http://memory-validation-agent:5002
      - DesignAgent__BaseUrl=http://memory-design-agent:5004
      - JobPersistence__Path=/data/memory/orchestrator/jobs
      # üóÇÔ∏è Path translation: Windows paths ‚Üí container paths
      - PathMapping__HostRoot=h:\code\git
      - PathMapping__ContainerRoot=/workspace
    depends_on:
      mcp-server:
        condition: service_healthy
      coding-agent:
        condition: service_healthy
      validation-agent:
        condition: service_healthy
      design-agent:
        condition: service_healthy
    networks:
      - memory-net
    # Need elevated permissions for Docker socket access
    privileged: false
    user: root
    restart: unless-stopped

  # CodingAgent - Generates and fixes code using LLM
  coding-agent:
    build:
      context: .
      dockerfile: CodingAgent.Server/Dockerfile
    container_name: memory-coding-agent
    ports:
      - "5001:5001"
    volumes:
      # üìÅ Workspace access for reading source files
      - h:\code\git:/workspace:rw
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:5001
      - MemoryAgent__BaseUrl=http://memory-agent-server:5000
      - Ollama__Url=http://10.10.1.114:11434
      # Dual GPU support (configure based on Gordon's GPU setup)
      - Gpu__DualGpu=false
      - Gpu__PinnedPort=11434
      - Gpu__SwapPort=11435
      - Gpu__PrimaryModel=deepseek-coder-v2:16b
      # üóÇÔ∏è Path translation: Windows paths ‚Üí container paths
      - PathMapping__HostRoot=h:\code\git
      - PathMapping__ContainerRoot=/workspace
    depends_on:
      mcp-server:
        condition: service_healthy
    networks:
      - memory-net
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5001/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 15s
    restart: unless-stopped

  # ValidationAgent - Validates code quality with LLM
  validation-agent:
    build:
      context: .
      dockerfile: ValidationAgent.Server/Dockerfile
    container_name: memory-validation-agent
    ports:
      - "5002:5002"
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:5002
      - MemoryAgent__BaseUrl=http://memory-agent-server:5000
      - Ollama__Url=http://10.10.1.114:11434
      - Gpu__ValidationModel=phi4:latest
      # Dual GPU support (configure based on Gordon's GPU setup)
      - Gpu__DualGpu=false
      - Gpu__PinnedPort=11434
      - Gpu__SwapPort=11435
    depends_on:
      mcp-server:
        condition: service_healthy
    networks:
      - memory-net
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5002/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 15s
    restart: unless-stopped

  # DesignAgent - UX Design system, brand guidelines, validation (now with LLM!)
  design-agent:
    build:
      context: .
      dockerfile: DesignAgent.Server/Dockerfile
    container_name: memory-design-agent
    ports:
      - "5004:5004"
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:5004
      - MemoryAgent__BaseUrl=http://memory-agent-server:5000
      # üß† LLM for creative brand generation and intelligent validation
      - Ollama__Url=http://10.10.1.114:11434
      - Ollama__Port=11434
      - Ollama__DefaultModel=deepseek-coder-v2:16b
    depends_on:
      mcp-server:
        condition: service_healthy
    networks:
      - memory-net
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5004/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 15s
    restart: unless-stopped

networks:
  memory-net:
    name: memory-shared-net
    driver: bridge
