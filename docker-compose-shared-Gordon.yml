services:
  mcp-server:
    build:
      context: .
      dockerfile: MemoryAgent.Server/Dockerfile
    container_name: memory-agent-server
    ports:
      - "5000:5000"
    volumes:
      - d:\Memory\shared\memory:/data/memory
      - d:\Memory\shared\logs:/data/logs
      - h:\code\git:/workspace:ro
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:5000
      - ASPNETCORE_HTTP_PORTS=
      - Qdrant__Url=http://memory-agent-qdrant:6333
      - Neo4j__Url=bolt://memory-agent-neo4j:7687
      - Neo4j__User=neo4j
      - Neo4j__Password=memoryagent
      - Ollama__Url=http://memory-agent-ollama:11434
      - PathMapping__HostRoot=h:\code\git
      - PathMapping__ContainerRoot=/workspace
      - AutoReindex__Enabled=true
      - AutoReindex__WorkspacePath=
      - AutoReindex__Context=
      - CodingOrchestrator__BaseUrl=http://memory-coding-orchestrator:5003
      - AutoTestGeneration__Enabled=true
    depends_on:
      qdrant:
        condition: service_healthy
      neo4j:
        condition: service_healthy
      ollama:
        condition: service_healthy
    deploy:
      resources:
        limits:
          memory: 108G
    networks:
      - memory-net
    restart: unless-stopped

  qdrant:
    image: qdrant/qdrant:latest
    container_name: memory-agent-qdrant
    ports:
      - "6333:6333"
      - "6334:6334"
    volumes:
      - d:\Memory\shared\qdrant:/qdrant/storage
    healthcheck:
      test: ["CMD-SHELL", "timeout 5 bash -c 'cat < /dev/null > /dev/tcp/localhost/6333' || exit 1"]
      interval: 10s
      timeout: 10s
      retries: 60
      start_period: 90s
    deploy:
      resources:
        limits:
          memory: 10G
    networks:
      - memory-net
    restart: unless-stopped

  neo4j:
    image: neo4j:5.15-community
    container_name: memory-agent-neo4j
    ports:
      - "7474:7474"
      - "7687:7687"
    volumes:
      - d:\Memory\shared\neo4j\data:/data
      - d:\Memory\shared\neo4j\logs:/logs
      - d:\Memory\shared\neo4j\import:/var/lib/neo4j/import
      - d:\Memory\shared\neo4j\plugins:/plugins
    environment:
      - NEO4J_AUTH=neo4j/memoryagent
      - NEO4J_PLUGINS=["apoc"]
      - NEO4J_dbms_memory_heap_max__size=6G
      - NEO4J_dbms_security_procedures_unrestricted=apoc.*
      - NEO4J_dbms_security_procedures_allowlist=apoc.*
      - NEO4J_dbms_threads_worker__count=16
      - NEO4J_dbms_memory_pagecache_size=2G
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --timeout=5 --spider http://localhost:7474 || exit 1"]
      interval: 15s
      timeout: 10s
      retries: 40
      start_period: 120s
    deploy:
      resources:
        limits:
          memory: 10G
    networks:
      - memory-net
    restart: unless-stopped

  ollama:
    image: ollama/ollama:latest
    container_name: memory-agent-ollama
    ports:
      - "11434:11434"
    volumes:
      - d:\Memory\shared\ollama:/root/.ollama
      - ./ollama-entrypoint.sh:/usr/local/bin/ollama-entrypoint.sh:ro
    entrypoint: ["/bin/bash", "/usr/local/bin/ollama-entrypoint.sh"]
    healthcheck:
      test: ["CMD", "bash", "-c", "ollama list | grep -q mxbai-embed-large"]
      interval: 10s
      timeout: 5s
      retries: 30
      start_period: 60s
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
    networks:
      - memory-net
    restart: unless-stopped

  # CodingOrchestrator - Coordinates the multi-agent workflow
  # üíæ NOW WITH JOB PERSISTENCE - survives container restarts!
  coding-orchestrator:
    build:
      context: .
      dockerfile: CodingOrchestrator.Server/Dockerfile
    container_name: memory-coding-orchestrator
    ports:
      - "5003:5003"
    volumes:
      # üíæ Job persistence - survives container restarts
      - d:\Memory\shared\memory:/data/memory
      # üìÅ Workspace access for reading/writing code files
      - h:\code\git:/workspace:rw
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:5003
      - MemoryAgent__BaseUrl=http://memory-agent-server:5000
      - CodingAgent__BaseUrl=http://memory-coding-agent:5001
      - ValidationAgent__BaseUrl=http://memory-validation-agent:5002
      - DesignAgent__BaseUrl=http://memory-design-agent:5004
      - JobPersistence__Path=/data/memory/orchestrator/jobs
      # üóÇÔ∏è Path translation: Windows paths ‚Üí container paths
      - PathMapping__HostRoot=h:\code\git
      - PathMapping__ContainerRoot=/workspace
    depends_on:
      - mcp-server
      - coding-agent
      - validation-agent
      - design-agent
    networks:
      - memory-net
    restart: unless-stopped

  # CodingAgent - Generates and fixes code using LLM
  coding-agent:
    build:
      context: .
      dockerfile: CodingAgent.Server/Dockerfile
    container_name: memory-coding-agent
    ports:
      - "5001:5001"
    volumes:
      # üìÅ Workspace access for reading source files
      - h:\code\git:/workspace:rw
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:5001
      - MemoryAgent__BaseUrl=http://memory-agent-server:5000
      - Ollama__Url=http://memory-agent-ollama:11434
      # üóÇÔ∏è Path translation: Windows paths ‚Üí container paths
      - PathMapping__HostRoot=h:\code\git
      - PathMapping__ContainerRoot=/workspace
    depends_on:
      - mcp-server
      - ollama
    networks:
      - memory-net
    restart: unless-stopped

  # ValidationAgent - Validates code quality
  validation-agent:
    build:
      context: .
      dockerfile: ValidationAgent.Server/Dockerfile
    container_name: memory-validation-agent
    ports:
      - "5002:5002"
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:5002
      - MemoryAgent__BaseUrl=http://memory-agent-server:5000
      - Ollama__Url=http://memory-agent-ollama:11434
    depends_on:
      - mcp-server
      - ollama
    networks:
      - memory-net
    restart: unless-stopped

  # DesignAgent - UX Design system, brand guidelines, validation
  design-agent:
    build:
      context: .
      dockerfile: DesignAgent.Server/Dockerfile
    container_name: memory-design-agent
    ports:
      - "5004:5004"
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:5004
      - MemoryAgent__BaseUrl=http://memory-agent-server:5000
    depends_on:
      - mcp-server
    networks:
      - memory-net
    restart: unless-stopped

networks:
  memory-net:
    name: memory-shared-net
    driver: bridge

